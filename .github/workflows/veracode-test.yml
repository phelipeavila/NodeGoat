name: Veracode Test
on: [push, pull_request]

jobs:
  Checkout:
    name: Checkout
    runs-on: self-hosted
    if: false
    steps:
      - name: Checkout https://github.com/${{ github.repository }}@${{ github.ref }}
        uses: actions/checkout@v2
        with:
          persist-credentials: false

  Veracode-SCA:
    name: Veracode SCA
    runs-on: self-hosted
    if: false
    needs: [Checkout]
    strategy:
      fail-fast: true
    steps:
      - name: Archive Release
        env:
          SRCCLR_API_TOKEN: ${{ secrets.SRCCLR_API_TOKEN }}
        run: |
          export SRCCLR_SCM_REF=${{ github.workflow }}
          export SRCCLR_SCM_REF_TYPE="branch"
          export SRCCLR_SCM_REV=${{ github.run_id }}
          export SRCCLR_SCM_TYPE="GITHUB"
          export EXTRA_ARGS='--update-advisor --uri-as-name' 
  
          curl -sSL https://download.sourceclear.com/ci.sh | bash -s -- scan $EXTRA_ARGS
        continue-on-error: true

  Veracode-SAST-Sandbox:
    name: Veracode SAST Sandbox
    runs-on: self-hosted
    #needs: [Veracode-SCA]
    strategy:
      fail-fast: true
    env:
      APPLICATION_NAME: NodeApp - test
    container:
      image: veracode/api-wrapper-java:latest
      options: --user root

    steps:
      - name: Checkout https://github.com/${{ github.repository }}@${{ github.ref }}
        uses: actions/checkout@v2
        with:
          persist-credentials: false
      
      - name: Scan
        run: |
          zip -r -v sourcefiles.zip . -i '*.js' '*.html'
          java -jar /opt/veracode/api-wrapper.jar -vid "${{ secrets.VERACODE_ID }}" -vkey "${{ secrets.VERACODE_KEY }}" -action UploadAndScan -sandboxname "SAND1" -createprofile false -appname "${{ env.APPLICATION_NAME }}" -version "${{ github.run_id }}" -filepath sourcefiles.zip
        continue-on-error: true


  Veracode-SAST-Pipeline:
    name: Veracode SAST Pipeline
    if: false
    runs-on: self-hosted
    needs: [Veracode-SCA]
    strategy:
      fail-fast: true
    env:
      APPLICATION_NAME: NodeApp - test
      POLICY_NAME: "Veracode Recommended Medium"
    container:
      image: veracode/pipeline-scan:latest
      options: --user root

    steps:
      - name: Checkout https://github.com/${{ github.repository }}@${{ github.ref }}
        uses: actions/checkout@v2
        with:
          persist-credentials: false
      
      - name: Scan
        run: |
          zip -r -v sourcefiles.zip . -i '*.js' '*.html'
          java -jar /opt/veracode/pipeline-scan.jar -vid "${{ secrets.VERACODE_ID }}" -vkey "${{ secrets.VERACODE_KEY }}" -f sourcefiles.zip -p "${{ env.APPLICATION_NAME }}" -pn "$POLICY_NAME"
    continue-on-error: true